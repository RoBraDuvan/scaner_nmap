package models

import (
	"time"

	"github.com/google/uuid"
)

// VulnerabilityScan represents a Nuclei vulnerability scan
type VulnerabilityScan struct {
	ID            uuid.UUID              `json:"id"`
	Name          string                 `json:"name"`
	Target        string                 `json:"target"`
	Status        string                 `json:"status"` // pending, running, completed, failed, cancelled
	Progress      int                    `json:"progress"`
	CreatedAt     time.Time              `json:"created_at"`
	StartedAt     *time.Time             `json:"started_at,omitempty"`
	CompletedAt   *time.Time             `json:"completed_at,omitempty"`
	ErrorMessage  *string                `json:"error_message,omitempty"`
	Configuration map[string]interface{} `json:"configuration,omitempty"`
	// Nuclei-specific fields
	Templates     []string               `json:"templates,omitempty"`      // Template IDs to use
	Severity      []string               `json:"severity,omitempty"`       // Filter by severity: info, low, medium, high, critical
	Tags          []string               `json:"tags,omitempty"`           // Filter by tags
}

// Vulnerability represents a single vulnerability finding from Nuclei
type Vulnerability struct {
	ID               uuid.UUID  `json:"id"`
	ScanID           uuid.UUID  `json:"scan_id"`
	TemplateID       string     `json:"template_id"`       // Nuclei template ID
	TemplateName     string     `json:"template_name"`     // Human-readable name
	Severity         string     `json:"severity"`          // info, low, medium, high, critical
	Type             string     `json:"type"`              // http, dns, network, file, etc.
	Host             string     `json:"host"`              // Target host
	MatchedAt        string     `json:"matched_at"`        // URL or location where vuln was found
	ExtractedResults []string   `json:"extracted_results,omitempty"` // Extracted data
	CURLCommand      string     `json:"curl_command,omitempty"`      // cURL command to reproduce
	Request          string     `json:"request,omitempty"`           // Raw request
	Response         string     `json:"response,omitempty"`          // Raw response
	Metadata         VulnMeta   `json:"metadata"`                    // Additional metadata
	CreatedAt        time.Time  `json:"created_at"`
}

// VulnMeta contains metadata about a vulnerability
type VulnMeta struct {
	Description    string            `json:"description,omitempty"`
	Reference      []string          `json:"reference,omitempty"`      // URLs to references
	CVE            []string          `json:"cve,omitempty"`            // CVE IDs
	CWE            []string          `json:"cwe,omitempty"`            // CWE IDs
	CVSS           map[string]string `json:"cvss,omitempty"`           // CVSS metrics
	Classification string            `json:"classification,omitempty"` // CVE, OWASP, etc.
	Tags           []string          `json:"tags,omitempty"`
	Author         []string          `json:"author,omitempty"`
}

// VulnScanLog represents a log entry for a vulnerability scan
type VulnScanLog struct {
	ID        uuid.UUID `json:"id"`
	ScanID    uuid.UUID `json:"scan_id"`
	Level     string    `json:"level"`     // info, warning, error
	Message   string    `json:"message"`
	CreatedAt time.Time `json:"created_at"`
}

// CreateVulnScanRequest represents the request to create a vulnerability scan
type CreateVulnScanRequest struct {
	Name          string                 `json:"name"`
	Target        string                 `json:"target"` // URL, IP, or file with targets
	Templates     []string               `json:"templates,omitempty"`
	Severity      []string               `json:"severity,omitempty"`
	Tags          []string               `json:"tags,omitempty"`
	Configuration map[string]interface{} `json:"configuration,omitempty"`
}

// VulnScanStats represents statistics for a vulnerability scan
type VulnScanStats struct {
	Total      int            `json:"total"`
	BySeverity map[string]int `json:"by_severity"` // count by severity level
	ByType     map[string]int `json:"by_type"`     // count by vuln type
}
