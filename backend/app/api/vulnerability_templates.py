"""
Vulnerability templates API endpoints for Nuclei scan presets
"""
from fastapi import APIRouter, HTTPException
from sqlalchemy import text
from app.core.database import get_db_session

router = APIRouter()


@router.get("/")
async def list_vulnerability_templates():
    """Get all vulnerability scan templates"""
    async with get_db_session() as session:
        result = await session.execute(
            text("""
                SELECT id, name, description, category, nuclei_tags,
                       nuclei_templates, severity_filter, configuration,
                       is_default, created_at
                FROM vulnerability_templates
                ORDER BY category, name
            """)
        )
        rows = result.fetchall()

        templates = []
        for row in rows:
            templates.append({
                "id": str(row.id),
                "name": row.name,
                "description": row.description,
                "category": row.category,
                "nuclei_tags": row.nuclei_tags,
                "nuclei_templates": row.nuclei_templates,
                "severity_filter": row.severity_filter,
                "configuration": row.configuration,
                "is_default": row.is_default,
                "created_at": row.created_at.isoformat() if row.created_at else None
            })

        return templates


@router.get("/{template_id}")
async def get_vulnerability_template(template_id: str):
    """Get a specific vulnerability template by ID"""
    async with get_db_session() as session:
        result = await session.execute(
            text("""
                SELECT id, name, description, category, nuclei_tags,
                       nuclei_templates, severity_filter, configuration,
                       is_default, created_at
                FROM vulnerability_templates
                WHERE id = :id
            """),
            {"id": template_id}
        )
        row = result.fetchone()

        if not row:
            raise HTTPException(status_code=404, detail="Template not found")

        return {
            "id": str(row.id),
            "name": row.name,
            "description": row.description,
            "category": row.category,
            "nuclei_tags": row.nuclei_tags,
            "nuclei_templates": row.nuclei_templates,
            "severity_filter": row.severity_filter,
            "configuration": row.configuration,
            "is_default": row.is_default,
            "created_at": row.created_at.isoformat() if row.created_at else None
        }
