-- Migration: Add vulnerability scanning tables for Nuclei integration
-- Created: 2025-11-17

-- Table for vulnerability scans
CREATE TABLE IF NOT EXISTS vulnerability_scans (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    target TEXT NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    progress INTEGER DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    error_message TEXT,
    templates TEXT[],
    severity TEXT[],
    tags TEXT[],
    configuration JSONB
);

-- Table for vulnerability findings
CREATE TABLE IF NOT EXISTS vulnerabilities (
    id UUID PRIMARY KEY,
    scan_id UUID NOT NULL REFERENCES vulnerability_scans(id) ON DELETE CASCADE,
    template_id VARCHAR(255) NOT NULL,
    template_name VARCHAR(500) NOT NULL,
    severity VARCHAR(50) NOT NULL,
    type VARCHAR(100) NOT NULL,
    host TEXT NOT NULL,
    matched_at TEXT,
    extracted_results TEXT[],
    curl_command TEXT,
    request TEXT,
    response TEXT,
    metadata JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Table for vulnerability scan logs
CREATE TABLE IF NOT EXISTS vulnerability_scan_logs (
    id UUID PRIMARY KEY,
    scan_id UUID NOT NULL REFERENCES vulnerability_scans(id) ON DELETE CASCADE,
    level VARCHAR(50) NOT NULL,
    message TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_vulnerability_scans_status ON vulnerability_scans(status);
CREATE INDEX IF NOT EXISTS idx_vulnerability_scans_created_at ON vulnerability_scans(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_scan_id ON vulnerabilities(scan_id);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_severity ON vulnerabilities(severity);
CREATE INDEX IF NOT EXISTS idx_vulnerabilities_created_at ON vulnerabilities(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_vulnerability_scan_logs_scan_id ON vulnerability_scan_logs(scan_id);
CREATE INDEX IF NOT EXISTS idx_vulnerability_scan_logs_created_at ON vulnerability_scan_logs(created_at ASC);

-- Comments for documentation
COMMENT ON TABLE vulnerability_scans IS 'Stores Nuclei vulnerability scan configurations and status';
COMMENT ON TABLE vulnerabilities IS 'Stores individual vulnerability findings from Nuclei scans';
COMMENT ON TABLE vulnerability_scan_logs IS 'Stores execution logs for vulnerability scans';

COMMENT ON COLUMN vulnerability_scans.status IS 'Scan status: pending, running, completed, failed, cancelled';
COMMENT ON COLUMN vulnerability_scans.templates IS 'Array of Nuclei template IDs to use';
COMMENT ON COLUMN vulnerability_scans.severity IS 'Array of severity filters: info, low, medium, high, critical';
COMMENT ON COLUMN vulnerability_scans.tags IS 'Array of tag filters for templates';
COMMENT ON COLUMN vulnerabilities.severity IS 'Vulnerability severity: info, low, medium, high, critical';
COMMENT ON COLUMN vulnerabilities.metadata IS 'Additional vulnerability metadata including CVE, CWE, CVSS, references';
